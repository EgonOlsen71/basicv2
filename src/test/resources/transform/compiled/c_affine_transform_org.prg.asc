100 rem@ £varstart $6590
110 ti$="000000"
120 dim pt%(4), cs%(18), xy%(18), ts%(12), ag(3)
130 w=40
140 tx=49152:tz=0:di=128
150 mp=25:tw=64:xd=.:yd=.:xh=.:yh=.:tc=.:t=.:l=.:r=.
160 tt=.:tl=.:tr=.:dl=.:dr=.:u0=.:u1=.:v0=.:v1=.
170 n=.:df=.:de=.:xs=.:xe=.:us=.:ue=.:vs=.:ve=.:kp=.
180 u=.:v=.:le=.:du=.:dv=.:x=.:y=.:z=.:tp=.:si=.
190 co=.:c=.:tv=.:mt=.:ma=.:xc=.:yv=.:zc=.:xn=.:yn=.:zn=.
200 gosub 2400
210 gosub 300
220 gosub 2310
230 gosub 2340
240 gosub 440
250 tt=ti
260 rem key: get a$:if a$=""then  key
270 gosub 370
280 print tt
290 end
300 rem jump target
310 poke 56576,(peek(56576) and 252) or 2
320 poke 53272,(peek(53272) and (255-8)) or 0
330 poke 53272,(peek(53272) and 15) or 128
340 poke 53265,peek(53265) or 32
350 poke 53270,peek(53270) or 16
360 return
370 rem jump target
380 poke 56576,(peek(56576) and 252) or 3
390 poke 53272, (peek(53272) and (255-8)) or 1
400 poke 53272,(peek(53272) and 15) or 16
410 poke 53265,peek(53265) and 223
420 poke 53270,peek(53270) and 239
430 return
440 rem jump target
450 gosub 2190
460 xd=200:yd=200
470 xh=xd/2:yh=yd/2
480 for i=0 to 3:pt%(i)=64/(2^(2*i)):nexti
490 w=0.3
500 gosub 520
510 return
520 rem jump target
530 ag(0)=w:ag(1)=0:ag(2)=w
540 gosub 1840
550 gosub 570
560 return
570 rem jump target
580 gosub 2310
590 tc=0
600 for i=0 to 17 step 9
610 t=0:l=3:r=6
620 tt=0:tl=2:tr=4
630 if xy%(i+4)>=xy%(i+1) then 660
640 t=3:l=6:r=0
650 tt=2:tl=4:tr=0
660 rem jump target
670 if xy%(i+7)>=xy%(i+t+1) then 700
680 t=6:l=0:r=3
690 tt=4:tl=0:tr=2
700 rem jump target
710 t=t+i
720 l=l+i
730 r=r+i
740 tt=tt+tc
750 tl=tl+tc
760 tr=tr+tc
770 dl=(xy%(l)-xy%(t))*di
780 dr=(xy%(r)-xy%(t))*di
790 u0=(ts%(tl)-ts%(tt))*di
800 u1=(ts%(tr)-ts%(tt))*di
810 v0=(ts%(tl+1)-ts%(tt+1))*di
820 v1=(ts%(tr+1)-ts%(tt+1))*di
830 n=l
840 if xy%(n+1)<=xy%(r+1) then 860
850 n=r
860 rem jump target
870 df=xy%(l+1)-xy%(t+1)
880 if df<>0 then 910
890 dl=0:u0=0:v0=0
900 goto 950
910 rem jump target
920 dl=dl/df
930 u0=u0/df
940 v0=v0/df
950 rem jump target
960 de=xy%(r+1)-xy%(t+1)
970 if de<>0 then 1000
980 dr=0:u1=0:v1=0
990 goto 1040
1000 rem jump target
1010 dr=dr/de
1020 u1=u1/de
1030 v1=v1/de
1040 rem jump target
1050 xs=xy%(t)*di
1060 us=ts%(tt)*di
1070 vs=ts%(tt+1)*di
1080 kp=(xy%(l)-xy%(t))*(xy%(r+1)-xy%(t+1))
1090 kp=kp-(xy%(l+1)-xy%(t+1))*(xy%(r)-xy%(t))
1100 sw=0
1110 if kp<=0 then 1190
1120 sw=1
1130 q=dl:dl=dr:dr=q
1140 q=df:df=de:de=q
1150 q=l:l=r:r=q
1160 q=tl:tl=tr:tr=q
1170 q=u0:u0=u1:u1=q
1180 q=v0:v0=v1:v1=q
1190 rem jump target
1200 y=xy%(t+1)
1210 ue=us
1220 ve=vs
1230 xe=xy%(r)*di-de*dr
1240 rem jump target
1250 for it=0 to 1
1260 rem jump target
1270 u=us:v=vs
1280 le=(xe-xs)/di
1290 du=0:dv=0
1300 if le=0 then 1330
1310 du=(ue-us)/le
1320 dv=(ve-vs)/le
1330 rem jump target
1340 mt=16384 + int(y/8)*320 + (y and 7)
1350 for x=int(xs/di) to int(xe/di)
1360 tp=((v/2) and 4032)+int(u/di)
1370 ma = mt + 2*(x and 252)
1380 poke ma, peek(ma) or (peek(tx+(tp and 4095))*pt%(x and 3))
1390 u=u+du:v=v+dv
1400 next x
1410 xs=xs+dl:xe=xe+dr
1420 us=us+u0:vs=vs+v0
1430 ue=ue+u1:ve=ve+v1
1440 y=y+1
1450 if y<=xy%(n+1) then 1260
1460 if n=r then 1630
1470 n=r
1480 dl=(xy%(r)-xy%(l))*di
1490 df=xy%(r+1)-xy%(l+1)
1500 xs=xy%(l)*di
1510 u0=(ts%(tr)-ts%(tl))*di
1520 v0=(ts%(tr+1)-ts%(tl+1))*di
1530 us=ts%(tl)*di
1540 vs=ts%(tl+1)*di
1550 if df<>0 then 1580
1560 dl=0:u0=0:v0=0
1570 goto 1790
1580 rem jump target
1590 dl=dl/df
1600 u0=u0/df
1610 v0=v0/df
1620 goto 1790
1630 rem jump target
1640 n=l
1650 dr=(xy%(l)-xy%(r))*di
1660 df=xy%(l+1)-xy%(r+1)
1670 xe=xy%(r)*di
1680 u1=(ts%(tl)-ts%(tr))*di
1690 v1=(ts%(tl+1)-ts%(tr+1))*di
1700 ue=ts%(tr)*di
1710 ve=ts%(tr+1)*di
1720 if df<>0 then 1750
1730 dr=0:u1=0:v1=0
1740 goto 1790
1750 rem jump target
1760 dr=dr/df
1770 u1=u1/df
1780 v1=v1/df
1790 rem jump target
1800 next it
1810 tc=tc+6
1820 next i
1830 return
1840 rem jump target
1850 c=0
1860 for p=0 to 17 step 3
1870 xc=cs%(p)
1880 yc=cs%(p+1)
1890 zc=cs%(p+2)+mp
1900 xn=xc:yn=yc:zn=zc
1910 if ag(0)=0 then 1980
1920 si=sin(ag(0))
1930 co=cos(ag(0))
1940 yn=(yc*co-zc*si)
1950 zn=(yc*si+zc*co)
1960 yc=yn
1970 zc=zn
1980 rem jump target
1990 if ag(1)=0 then 2060
2000 si=sin(ag(1))
2010 co=cos(ag(1))
2020 zn=(zc*co-xc*si)
2030 xn=(zc*si+xc*co)
2040 xc=xn
2050 zc=zn
2060 rem jump target
2070 if ag(2)=0 then 2120
2080 si=sin(ag(2))
2090 co=cos(ag(2))
2100 xn=(xc*co-yc*si)
2110 yn=(xc*si+yc*co)
2120 rem jump target
2130 zn=zn-mp
2140 xy%(c)=(xh+((xn*di)/zn))/2:c=c+1
2150 xy%(c)=yh+((yn*di)/zn):c=c+1
2160 xy%(c)=z:c=c+1
2170 next p
2180 return
2190 rem jump target
2200 cs%(0)=-10:cs%(1)=10:cs%(2)=-mp
2210 cs%(3)=10:cs%(4)=-10:cs%(5)=-mp
2220 cs%(6)=-10:cs%(7)=-10:cs%(8)=-mp
2230 cs%(9)=10:cs%(10)=10:cs%(11)=-mp
2240 cs%(12)=10:cs%(13)=-10:cs%(14)=-mp
2250 cs%(15)=-10:cs%(16)=10:cs%(17)=-mp
2260 ts%(0)=tw:ts%(1)=0:ts%(2)=0
2270 ts%(3)=tw:ts%(4)=tw:ts%(5)=tw
2280 ts%(6)=0:ts%(7)=0:ts%(8)=0
2290 ts%(9)=tw:ts%(10)=tw:ts%(11)=0
2300 return
2310 rem jump target
2320 for i=16384to24383:pokei,0:nexti
2330 return
2340 rem jump target
2350 poke 53281,1
2360 v=14+6*16
2370 for i = 24576 to 25575:poke i,v:next i
2380 for i = 55296 to 56295:poke i,2:next i
2390 return
2400 rem jump target
2410 print"{clr}unpacking texture..."
2420 p=tx
2430 rem jump target
2440 read c,v%
2450 if c=0 then 2520
2460 for i=1 to c
2470 pokep,v%
2480 poke 53280,v%
2490 p=p+4
2500 nexti
2510 goto 2430
2520 rem jump target
2530 for i=tx to tx+4095 step 4
2540 v=peek(i)
2550 poke i+0, (v and 192)/64
2560 poke i+1, (v and 48)/16
2570 poke i+2, (v and 12)/4
2580 poke i+3, (v and 3)
2590 poke 53280,v
2600 next i
2610 return
2620 data 199,170,1,85,1,90,13,170,1,149,2,85,12,170,1,169
2630 data 3,85,12,170,1,165,3,85,12,170,4,85,11,170,1,169
2640 data 4,85,11,170,1,169,4,85,11,170,1,165,4,85,11,170
2650 data 1,149,2,85,1,170,1,169,11,170,1,149,1,85,1,90
2660 data 13,170,2,85,1,106,2,170,3,85,1,106,7,170,2,85
2670 data 3,170,3,85,8,170,1,85,1,86,3,170,2,85,1,86,8,170
2680 data 1,85,1,86,3,170,2,85,1,90,7,170,1,169,1,85,1,86
2690 data 3,170,2,85,1,106,7,170,1,169,1,85,1,86,3,170,2
2700 data 85,8,170,1,169,1,85,1,86,13,170,1,169,1,85,1,86
2710 data 13,170,1,169,1,85,1,86,3,170,2,255,1,106,7,170
2720 data 1,169,1,85,1,86,3,170,2,255,1,218,8,170,1,85,1
2730 data 86,3,170,2,255,1,250,8,170,2,85,3,170,2,255,1
2740 data 254,8,170,2,85,3,170,3,255,8,170,1,149,1,85,1
2750 data 106,2,170,3,255,1,234,7,170,1,149,1,85,1,86,13
2760 data 170,1,165,2,85,1,106,1,165,11,170,1,165,4,85,11
2770 data 170,1,169,4,85,12,170,4,85,12,170,1,149,3,85,12
2780 data 170,1,169,3,85,13,170,3,85,13,170,1,169,1,85,1
2790 data 86,40,170,1,165,8,170,1,169,6,170,1,154,8,170
2800 data 1,169,6,170,1,90,1,165,1,90,1,85,1,150,1,153,1
2810 data 101,1,165,1,106,1,89,1,165,1,105,1,154,1,90,2
2820 data 170,1,106,1,166,1,150,1,105,1,166,1,154,1,105
2830 data 1,166,1,153,1,105,1,150,1,153,1,105,1,166,2,170
2840 data 1,90,1,166,1,150,1,105,1,165,1,154,1,105,1,150
2850 data 1,153,1,105,1,154,1,153,1,105,1,86,2,170,1,150
2860 data 1,166,1,154,1,105,1,165,1,154,1,105,1,166,1,153
2870 data 1,105,1,150,1,153,1,169,1,106,2,170,2,169,1,106
2880 data 1,105,1,166,1,154,1,105,1,169,1,106,1,85,1,165
2890 data 1,105,1,170,1,86,160,170,1,170
2900 data 0,0
